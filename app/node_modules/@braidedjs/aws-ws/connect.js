import { log } from 'shared/log.js'
import DynamoDB from 'aws-sdk/clients/dynamodb'

const db = new DynamoDB()
const TableName = process.env.TABLE_NAME

const handler = async (event, context) => {
	const { apiId, connectionId, authorizer: { principalId: userId, sessionId } } = event.requestContext
	const result = await db.putItem({
		Item: {
			pk: {
				S: `user:${userId}:conn`
			},
			sk: {
				S: `sess:${sessionId}:conn:${connectionId}`
			},
			gid: {
				S: `ws:${userId}:conn:${connectionId}`
			},
			api: {
				S: apiId
			},
			session: {
				M: {
					headers: {
						S: JSON.stringify(event.headers)
					}
				}
			}
		}, 
		ReturnConsumedCapacity: 'TOTAL', 
		TableName
	}).promise()
	log.info('connect', { result, event })
	return { statusCode: 200 }
}

export default { handler }
